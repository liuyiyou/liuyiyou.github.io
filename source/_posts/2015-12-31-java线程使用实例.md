date: "2015-12-31"
title: java线程使用实例
categories: 
  - java
tags : 
 - 并发
---

项目过程中遇到如下场景：

从前台导入csv文件，在后台需要对文件解析，解析后封装成一个对象，然后将对象插入到数据库中。插入数据库后，需要将数据库中的记录通过一定的条件同步到另外几个表中，逻辑比较简单，但是有一些需求或者项目规划的原因导致以下问题

1. 需求方要求可以导入大量数据，而且前台能给出导入成功或者失败的提示

2. 后台需要调用远程服务来解析文件，才能入库，而远程服务速度并不是很快

3. 需要将数据进行一系列计算或者汇总后同步到另外的中间表或者汇总表中


步骤描述如下:

```java

	@Test
	public void demoTest() {

		// 1:导入文件解析
		List<User> users = parse();

		// 2:将解析后的文件导入数据库
		int result = intoDB(users);

		// 3:同步到A表
		syncTableA(users);

		// 4:同步到B表
		syncTableB(users);

		// 返回结果
		System.out.println("返回结果"+result);
	}
	
	
	private void syncTableA(List<User> users) {
		System.out.println("同步到A表成功");
	}

	private void syncTableB(List<User> users) {
		System.out.println("同步到B表成功");
	}



	private int intoDB(List<User> users) {
		System.out.println("导入数据库成功");
		return users.size();
	}

	private List<User> parse() {
		List<User> users = new ArrayList<User>();
		for (int i = 0; i < 100; i++) {
			User user = new User(i, 18 + i, "name" + i);
			users.add(user);
		}
		System.out.println("解析完成");
		return users;
	}
```

逻辑还是挺清晰的，但是实际情况下，会有以下问题

解析过程需要的时间比较长，而且还需要调用远程服务，此外同步到其他表还需要一定的计算，导致如果数据量稍微大一点的时候，后台NIO阻塞，虽然不影响实际结果，但是前台会报错。

需求方要求前台必须显示导入的结果信息，前台报错的话，非开发人员会认为是导入错误了。

问题1：如果出在解析同步数据时间超长

解决方案：同步采用多线程:



```java

	@Test
	public void demoTest() {

		ExecutorService executorService = Executors.newSingleThreadExecutor();
		
		// 1:导入文件解析
		final List<User> users = parse();

		// 2:将解析后的文件导入数据库
		int result = intoDB(users);

		executorService.execute(new Runnable() {
			@Override
			public void run() {
				// 3:同步到A表
				syncTableA(users);
			}
		});
		executorService.execute(new Runnable() {
			@Override
			public void run() {
				// 4:同步到B表
				syncTableB(users);
			}
		});
		// 返回结果,这个是放在最后
		System.out.println("返回结果"+result);
	}

```

这样能解决同步时间太长导致的超时问题。而且前台能返回导入后的结果信息，但是实际情况却是，解析太慢了，导致还没有解析就出错了。主要出现在解析过程中调用服务的情况


第二种方案：

在第一种方案的基础上更近一步，不解析直接插入到数据库，前台直接返回，后台再开一个线程，用来更新数据库

这样也能保证前台能得到结果输出，但是这样有一个问题：后面同步表的方法需要运行的前提是，第一个线程需要更新完成。







