title: 2017-09-05-查询缓存问题
date: 2017-09-05
categories : 
  - redis
tags : 
  - mybatis
  - redis
---


1、列表查询或分页查询

在查询的时候，会对该列表进行缓存，缓存的key=ClassSimpleName:total 。其中key=默认会给一个30秒的过期时间，也就是说，常规情况下，更新列表中的某条数据后，在30秒钟再次查询该列表的时候，数据还是原来的数据(缓存脏读)，如果不设置过期，则是否更新数据，列表中的数据都不会变化，不符合要求，所以，及要求能快速查询数据又要准确是不可兼得的。

但是这样有一个问题，和数据库读写分离类似，大部分情况下都是查询比较多，而更新相对较少。如果查询结果只是缓存30秒，实际的意义并不是很大。

有没有更好的方案呢？在更新或删除该类的时候，与该类有关的列表查询从缓存中清除，


实现方式：

updateEntityStart

    deleteEntityListCache
    deleteEntityCache
    addEntityCache

updateEntityEnd


这种方式看上去可以，更新或删除实体的时候，删除列表中的缓存数据，再次查询的时候走数据库，并设置不过期时间

但是实际上是行不通的。  

1是每次更新都要删掉缓存列表和30秒过期差不多。 

2是在多用户下，仅仅因为某个用户更新了某个列表，导致其他人查询都走DB，体验并不是很好


终极解决方案：

直接在缓存中进行排序 ，还没有实现，可以通过redis的 sortlist来实现